title: epoll多路复用
date: 2019-07-01
tags: ['epoll', 'linux']
---


# epoll
全称 `EventPoll`。是 linux 内核实现IO多路复用x的一个实现。IO多路复用的意思是在一个操作里同时监听多个输入输出源，在其中一个或多个输入输出源可用的时候返回，然后对其的进行读写操作。

## epoll

epoll 监听的 fd（file descriptor）集合是常驻内核的，它有 3 个系统调用

* epoll_create
* epoll_wait
* epoll_ctl

通过 `epoll_wait` 可以多次监听同一个 fd 集合，只返回可读写那部分。

## select
 只有一个系统调用，每次要监听都要将其从用户态传到内核，有事件时返回整个集合。


## 比较

从性能上看，如果 fd 集合很大，用户态和内核态之间数据复制的花销是很大的，所以 select 一般限制 fd 集合最大1024。

从使用上看，epoll 返回的是可用的 fd 子集，select 返回的是全部，哪些可用需要用户遍历判断。

尽管如此，`epoll` 的性能并不必然比 `select` 高，对于 fd 数量较少并且 fd IO 都非常繁忙的情况 select 在性能上有优势。


|系统调用 |select| poll |epoll|
|:-----:|:----:|:----:|:-----:|
|事件集合|用户通过3个参数分别传入感兴趣的可读，可写及异常等事件。内核通过对这些参数的在线修改来反馈其中的就绪事件。这使得用户每次调用select都要重置这3个参数|统一处理所有事件类型，因此只需要一个事件集参数。用户通过pollfd.events传入感兴趣的事件，内核通过修改pollfd.revents反馈其中就绪的事件|内核通过一个事件表直接管理用户感兴趣的所有事件。因此每次调用epoll_wait时，无需反复传入用户感兴趣的事件。epoll_wait系统调用的参数events仅用来反馈就绪的事件 |
|应用程序索引就绪文件描述符的时间复杂度|O(n)|O(n)|O(1)|
|最大支持文件描述符数|一般有最大值限制|65535|65535|
|工作模式|LT|LT|支持ET高效模式|
|内核实现和工作效率|采用轮询方式检测就绪事件，时间复杂度：O(n)|采用轮询方式检测就绪事件，时间复杂度：O(n)|采用回调方式检测就绪事件，时间复杂度：O(1)|
